<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPS Différé PRO</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        #menu { background: #222; padding: 15px; display: flex; justify-content: center; align-items: center; gap: 15px; border-bottom: 2px solid #444; }
        .container { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #111; }
        
        /* On affiche un Canvas au lieu d'une balise Video */
        canvas { max-width: 100%; max-height: 100%; transform: scaleX(-1); background: #000; }
        
        button { padding: 12px 20px; font-size: 16px; border-radius: 8px; border: none; background: #27ae60; color: white; font-weight: bold; cursor: pointer; }
        input[type="range"] { width: 150px; }
        .info { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="menu">
        <button id="btnStart">DÉMARRER CAMÉRA</button>
        <div id="uiControls" style="display:none;">
            <span>Délai : <b id="delayVal">5</b>s</span>
            <input type="range" id="delayRange" min="1" max="20" value="5">
        </div>
    </div>

    <div class="container">
        <div class="info" id="status">En attente...</div>
        <canvas id="displayCanvas"></canvas>
    </div>

    <video id="hiddenVideo" autoplay playsinline muted style="display:none;"></video>

<script>
    const btnStart = document.getElementById('btnStart');
    const video = document.getElementById('hiddenVideo');
    const canvas = document.getElementById('displayCanvas');
    const ctx = canvas.getContext('2d');
    const delayRange = document.getElementById('delayRange');
    const delayVal = document.getElementById('delayVal');
    const status = document.getElementById('status');

    let buffer = [];
    let delayInSeconds = 5;
    const fps = 20; // On capture 20 images par seconde (suffisant pour l'EPS)

    btnStart.onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 640, height: 480 }, 
                audio: false 
            });
            video.srcObject = stream;
            video.play();
            
            btnStart.style.display = 'none';
            document.getElementById('uiControls').style.display = 'block';
            status.innerText = "Initialisation...";

            // Ajuster la taille du canvas quand la vidéo commence
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                startLoop();
            };
        } catch (err) {
            alert("Erreur caméra : " + err.message);
        }
    };

    delayRange.oninput = () => {
        delayInSeconds = delayRange.value;
        delayVal.innerText = delayInSeconds;
    };

    function startLoop() {
        setInterval(() => {
            // 1. Capturer l'image actuelle de la caméra
            // On crée un canvas temporaire pour stocker l'image
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 2. Ajouter cette image au buffer
            buffer.push(tempCanvas);

            // 3. Calculer combien d'images on doit avoir en stock pour le délai
            const requiredFrames = delayInSeconds * fps;

            if (buffer.length > requiredFrames) {
                // On récupère l'image la plus ancienne (celle d'il y a X secondes)
                const frameToDisplay = buffer.shift();
                // On l'affiche sur le canvas principal
                ctx.drawImage(frameToDisplay, 0, 0);
                status.innerText = "MODE DIFFÉRÉ ACTIF";
            } else {
                status.innerText = "Mise en mémoire : " + Math.round((buffer.length/requiredFrames)*100) + "%";
            }
        }, 1000 / fps);
    }
</script>
</body>
</html>
