<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EPS Vidéo Différé V2</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; text-align: center; }
        #header { background: #222; padding: 10px; display: flex; justify-content: space-around; align-items: center; z-index: 100; position: relative;}
        
        .main-container { position: relative; width: 100vw; height: 80vh; background: #111; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        
        /* Petit retour direct pour vérification */
        #livePreview { position: absolute; bottom: 10px; left: 10px; width: 150px; border: 2px solid white; border-radius: 8px; transform: scaleX(-1); }
        
        .controls { padding: 20px; }
        button { padding: 15px 25px; font-size: 18px; border-radius: 10px; border: none; background: #27ae60; color: white; font-weight: bold; }
        input[type="range"] { width: 60%; margin: 10px; }
        .label { font-size: 1.2em; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="header">
        <div>Délai: <span id="delayVal">5</span>s</div>
        <input type="range" id="delayRange" min="1" max="20" value="5">
    </div>

    <div class="main-container">
        <video id="delayedVideo" autoplay playsinline muted></video>
        <video id="livePreview" autoplay playsinline muted></video>
    </div>

    <div class="controls">
        <button id="startBtn">ACTIVER LA CAMÉRA</button>
        <p id="status" style="color: #aaa; font-size: 0.8em;">Cliquez sur Activer pour démarrer</p>
    </div>

<script>
    const startBtn = document.getElementById('startBtn');
    const delayedVideo = document.getElementById('delayedVideo');
    const livePreview = document.getElementById('livePreview');
    const delayRange = document.getElementById('delayRange');
    const delayVal = document.getElementById('delayVal');
    const statusText = document.getElementById('status');

    let chunks = [];
    let recorder;
    let delay = 5;

    delayRange.oninput = () => { delay = delayRange.value; delayVal.innerText = delay; };

    startBtn.onclick = async () => {
        try {
            // 1. Demander la caméra
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment", 
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }, 
                audio: false 
            });

            // 2. Afficher le direct tout de suite
            livePreview.srcObject = stream;
            statusText.innerText = "Caméra OK. Initialisation du différé...";
            startBtn.style.display = 'none';

            // 3. Détecter le format supporté (Crucial pour iOS)
            let mimeType = 'video/webm;codecs=vp8';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'video/mp4'; // Format Apple
            }

            // 4. Configurer le recorder
            recorder = new MediaRecorder(stream, { mimeType });
            
            recorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    chunks.push(e.data);
                    processBuffer();
                }
            };

            // On enregistre par tranches de 500ms
            recorder.start(500);

        } catch (err) {
            alert("Erreur : " + err.message);
            statusText.innerText = "Erreur d'accès caméra.";
        }
    };

    function processBuffer() {
        // On calcule combien de chunks on doit attendre
        // Si on enregistre toutes les 0.5s, pour 5s il faut 10 chunks.
        const requiredChunks = delay * 2;

        if (chunks.length >= requiredChunks) {
            // On crée un "mini-film" avec les chunks accumulés
            const blob = new Blob(chunks, { type: recorder.mimeType });
            const url = URL.createObjectURL(blob);
            
            // Si la vidéo différée ne joue pas encore, on la lance
            if (delayedVideo.paused) {
                delayedVideo.src = url;
                delayedVideo.play();
                statusText.innerText = "MODE DIFFÉRÉ ACTIF";
            }
            
            // Pour éviter de saturer la mémoire, on garde une marge
            if (chunks.length > requiredChunks + 20) {
                chunks.shift(); // Supprime le plus vieux chunk
            }
        }
    }
</script>
</body>
</html>
