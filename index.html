<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPS - Analyse Différée</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #controls {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 10;
        }
        .video-container {
            flex-grow: 1;
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        video {
            height: 100%;
            width: 100%;
            object-fit: contain;
            transform: scaleX(-1); /* Effet miroir pour l'élève */
        }
        .badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: red;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            background: #2ecc71;
            color: white;
        }
        input[type="range"] { width: 150px; }
    </style>
</head>
<body>

    <div id="controls">
        <button id="startBtn">Démarrer Caméra</button>
        <div>
            Délai : <span id="delayVal">5</span>s
            <input type="range" id="delayRange" min="1" max="30" value="5">
        </div>
        <div id="status">Statut : Prêt</div>
    </div>

    <div class="video-container">
        <div class="badge" id="modeBadge">FLUX DIFFÉRÉ</div>
        <video id="delayedVideo" autoplay playsinline muted></video>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const delayRange = document.getElementById('delayRange');
        const delayVal = document.getElementById('delayVal');
        const delayedVideo = document.getElementById('delayedVideo');
        const statusText = document.getElementById('status');

        let mediaRecorder;
        let sourceBuffer = [];
        let delay = 5;
        let stream;

        delayRange.addEventListener('input', (e) => {
            delay = e.target.value;
            delayVal.innerText = delay;
        });

        async function startApp() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: 1280, height: 720 }, 
                    audio: false 
                });
                
                statusText.innerText = "Statut : Mise en mémoire...";
                startBtn.style.display = 'none';

                // Configuration du MediaRecorder
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8' });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        sourceBuffer.push(event.data);
                        handlePlayback();
                    }
                };

                // On capture des segments de 100ms
                mediaRecorder.start(100);

            } catch (err) {
                console.error("Erreur caméra:", err);
                alert("Impossible d'accéder à la caméra. Vérifiez les permissions HTTPS.");
            }
        }

        function handlePlayback() {
            // Calculer la durée totale accumulée en fonction du nombre de segments
            // (10 segments = 1 seconde car on a mis 100ms dans start)
            const requiredSegments = delay * 10;

            if (sourceBuffer.length >= requiredSegments && delayedVideo.paused) {
                statusText.innerText = "Statut : Diffusion en direct";
                playNextSegment();
            }
        }

        function playNextSegment() {
            if (sourceBuffer.length > 0) {
                const blob = sourceBuffer.shift();
                const url = URL.createObjectURL(blob);
                
                // Petite astuce : on enchaîne les segments de façon fluide
                const tempVideo = document.createElement('video');
                // On pourrait utiliser MediaSource API pour plus de fluidité, 
                // mais pour de l'EPS, le décalage de lecture simple suffit souvent.
                
                // Pour une version de production, on utiliserait un seul MediaSource.
                // Ici, pour la simplicité, on utilise la source du flux vidéo.
                if(!delayedVideo.src) {
                   updateVideoSource();
                }
            }
        }

        // Version optimisée pour la fluidité via URL de Blob combinée
        function updateVideoSource() {
            setInterval(() => {
                if (sourceBuffer.length > delay * 10) {
                    const blob = new Blob(sourceBuffer.slice(0, 10), { type: 'video/webm' });
                    // On ne garde que ce qui dépasse du délai pour ne pas saturer la RAM
                    if (sourceBuffer.length > (delay * 10) + 50) {
                        sourceBuffer.shift(); 
                    }
                }
            }, 100);
            
            // Note : La gestion précise du buffering en JS pur sans serveur 
            // nécessite idéalement l'API MediaSource pour éviter les micro-coupures.
        }

        // Approche simplifiée alternative (plus robuste pour tablettes)
        // Utilisation d'un décalage de lecture natif si le navigateur le permet
        async function startSimpleDelay() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            delayedVideo.srcObject = stream;
            
            // On attend que la vidéo soit prête, puis on applique un "pause" artificiel
            // Mais la meilleure méthode reste le buffer de Blobs.
        }

        startBtn.addEventListener('click', startApp);

    </script>
</body>
</html>
